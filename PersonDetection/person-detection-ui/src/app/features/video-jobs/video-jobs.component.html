<!-- src/app/features/video-jobs/video-jobs.component.html -->

<div class="video-jobs-container">
    <!-- Header -->
    <div class="page-header">
        <div class="header-content">
            <div class="title-section">
                <mat-icon class="title-icon">video_library</mat-icon>
                <div>
                    <h1>Video Processing</h1>
                    <p>Upload and analyze videos for person detection</p>
                </div>
            </div>
            <button mat-raised-button color="primary" (click)="openUploadDialog()" class="upload-btn">
                <mat-icon>cloud_upload</mat-icon>
                Upload Video
            </button>
        </div>
    </div>

    <!-- Stats Summary -->
    <div class="stats-summary">
        <div class="stat-item">
            <mat-icon>folder</mat-icon>
            <div class="stat-content">
                <span class="stat-value">{{ jobs().length + historyTotal() }}</span>
                <span class="stat-label">Total Jobs</span>
            </div>
        </div>
        <div class="stat-item processing">
            <mat-icon>sync</mat-icon>
            <div class="stat-content">
                <span class="stat-value">{{ processingCount() }}</span>
                <span class="stat-label">Processing</span>
            </div>
        </div>
        <div class="stat-item completed">
            <mat-icon>check_circle</mat-icon>
            <div class="stat-content">
                <span class="stat-value">{{ completedCount() + historyTotal() }}</span>
                <span class="stat-label">Completed</span>
            </div>
        </div>
        <div class="stat-item persons">
            <mat-icon>people</mat-icon>
            <div class="stat-content">
                <span class="stat-value">{{ totalUniquePersons() + totalHistoryPersons() }}</span>
                <span class="stat-label">Unique Persons</span>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <mat-tab-group class="jobs-tabs">
        <!-- Active Jobs Tab -->
        <mat-tab>
            <ng-template mat-tab-label>
                <mat-icon>work</mat-icon>
                <span>Active Jobs</span>
                @if (processingCount() > 0) {
                <span class="tab-badge processing">{{ processingCount() }}</span>
                }
            </ng-template>

            <div class="tab-content">
                @if (isLoading()) {
                <div class="loading-state">
                    <mat-spinner diameter="40"></mat-spinner>
                    <p>Loading jobs...</p>
                </div>
                } @else if (jobs().length === 0) {
                <div class="empty-state">
                    <mat-icon>video_library</mat-icon>
                    <h3>No Active Jobs</h3>
                    <p>Upload a video to start processing</p>
                    <button mat-raised-button color="primary" (click)="openUploadDialog()">
                        <mat-icon>cloud_upload</mat-icon>
                        Upload Video
                    </button>
                </div>
                } @else {
                <div class="jobs-grid">
                    @for (job of jobs(); track job.jobId) {
                    <div class="job-card" [class]="getStateClass(job.state)">
                        <!-- Card Header -->
                        <div class="card-header">
                            <div class="status-icon" [class]="getStateClass(job.state)">
                                <mat-icon>{{ getStateIcon(job.state) }}</mat-icon>
                            </div>
                            <div class="card-title">
                                <h4>{{ job.fileName }}</h4>
                                <span class="status-badge" [class]="getStateClass(job.state)">
                                    {{ getStateLabel(job.state) }}
                                </span>
                            </div>
                            <button mat-icon-button [matMenuTriggerFor]="jobMenu" class="menu-btn">
                                <mat-icon>more_vert</mat-icon>
                            </button>
                            <mat-menu #jobMenu="matMenu">
                                <button mat-menu-item (click)="viewDetails(job)">
                                    <mat-icon>visibility</mat-icon>
                                    <span>View Details</span>
                                </button>
                                @if (job.state === VideoProcessingState.Processing) {
                                <button mat-menu-item (click)="cancelJob(job)">
                                    <mat-icon>cancel</mat-icon>
                                    <span>Cancel</span>
                                </button>
                                }
                                <button mat-menu-item (click)="deleteJob(job)" class="delete-item">
                                    <mat-icon>delete</mat-icon>
                                    <span>Delete</span>
                                </button>
                            </mat-menu>
                        </div>

                        <!-- Progress Section (Processing) -->
                        @if (job.state === VideoProcessingState.Processing) {
                        <div class="progress-section">
                            <div class="progress-header">
                                <span>Progress</span>
                                <span class="progress-percent">{{ job.progressPercent }}%</span>
                            </div>
                            <mat-progress-bar mode="determinate" [value]="job.progressPercent" color="primary">
                            </mat-progress-bar>
                            <div class="progress-stats">
                                <span>{{ job.processedFrames }} / {{ job.totalFrames || '?' }} frames</span>
                            </div>
                        </div>
                        }

                        <!-- Stats -->
                        <div class="card-stats">
                            <div class="stat">
                                <mat-icon>person</mat-icon>
                                <span>{{ job.totalPersonsDetected }} detections</span>
                            </div>
                            <div class="stat">
                                <mat-icon>fingerprint</mat-icon>
                                <span>{{ job.uniquePersonsDetected }} unique</span>
                            </div>
                        </div>

                        <!-- Timestamps -->
                        <div class="card-timestamps">
                            <span>Started: {{ job.startedAt | date:'short' }}</span>
                            @if (job.completedAt) {
                            <span>Completed: {{ job.completedAt | date:'short' }}</span>
                            }
                        </div>

                        <!-- Actions -->
                        <div class="card-actions">
                            @if (job.state === VideoProcessingState.Completed) {
                            <button mat-button color="primary" (click)="viewDetails(job)">
                                <mat-icon>assessment</mat-icon>
                                View Results
                            </button>
                            } @else if (job.state === VideoProcessingState.Processing) {
                            <button mat-button color="primary" (click)="viewDetails(job)">
                                <mat-icon>visibility</mat-icon>
                                View Progress
                            </button>
                            } @else {
                            <button mat-button (click)="viewDetails(job)">
                                <mat-icon>info</mat-icon>
                                Details
                            </button>
                            }
                        </div>
                    </div>
                    }
                </div>
                }
            </div>
        </mat-tab>

        <!-- Video History Tab -->
        <mat-tab>
            <ng-template mat-tab-label>
                <mat-icon>history</mat-icon>
                <span>Video History</span>
                @if (historyTotal() > 0) {
                <span class="tab-badge">{{ historyTotal() }}</span>
                }
            </ng-template>

            <div class="tab-content">
                @if (historyLoading()) {
                <div class="loading-state">
                    <mat-spinner diameter="40"></mat-spinner>
                    <p>Loading history...</p>
                </div>
                } @else if (videoHistory().length === 0) {
                <div class="empty-state">
                    <mat-icon>history</mat-icon>
                    <h3>No History</h3>
                    <p>Completed videos will appear here</p>
                </div>
                } @else {
                <div class="jobs-grid">
                    @for (video of videoHistory(); track video.jobId) {
                    <div class="job-card completed">
                        <!-- Card Header -->
                        <div class="card-header">
                            <div class="status-icon completed">
                                <mat-icon>check_circle</mat-icon>
                            </div>
                            <div class="card-title">
                                <h4>{{ video.fileName }}</h4>
                                <span class="status-badge" [class]="getStateClass(video.state)">
                                    {{ video.state }}
                                </span>
                            </div>
                            <button mat-icon-button [matMenuTriggerFor]="historyMenu" class="menu-btn">
                                <mat-icon>more_vert</mat-icon>
                            </button>
                            <mat-menu #historyMenu="matMenu">
                                <button mat-menu-item (click)="viewHistoryDetails(video)">
                                    <mat-icon>visibility</mat-icon>
                                    <span>View Details</span>
                                </button>
                                <button mat-menu-item (click)="playVideo(video)">
                                    <mat-icon>play_arrow</mat-icon>
                                    <span>Play Video</span>
                                </button>
                                <button mat-menu-item (click)="deleteHistoryItem(video)" class="delete-item">
                                    <mat-icon>delete</mat-icon>
                                    <span>Delete</span>
                                </button>
                            </mat-menu>
                        </div>

                        <!-- Video Info -->
                        <div class="video-info-grid">
                            <div class="info-item">
                                <mat-icon>timer</mat-icon>
                                <span>{{ formatDuration(video.videoDurationSeconds) }}</span>
                            </div>
                            <div class="info-item">
                                <mat-icon>photo_library</mat-icon>
                                <span>{{ video.processedFrames }} frames</span>
                            </div>
                            <div class="info-item">
                                <mat-icon>person</mat-icon>
                                <span>{{ video.totalDetections }} detections</span>
                            </div>
                            <div class="info-item highlight">
                                <mat-icon>fingerprint</mat-icon>
                                <span>{{ video.uniquePersonCount }} unique</span>
                            </div>
                        </div>

                        <!-- Timestamps -->
                        <div class="card-timestamps">
                            <span>{{ video.createdAt | date:'medium' }}</span>
                            <span>{{ formatProcessingTime(video.processingTimeSeconds) }}</span>
                        </div>

                        <!-- Actions -->
                        <div class="card-actions">
                            <button mat-button (click)="playVideo(video)">
                                <mat-icon>play_arrow</mat-icon>
                                Play
                            </button>
                            <button mat-button color="primary" (click)="viewHistoryDetails(video)">
                                <mat-icon>assessment</mat-icon>
                                Details
                            </button>
                        </div>
                    </div>
                    }
                </div>

                <!-- Pagination -->
                <mat-paginator [length]="historyTotal()" [pageSize]="historyPageSize()"
                    [pageSizeOptions]="[5, 10, 25, 50]" (page)="onHistoryPageChange($event)" showFirstLastButtons>
                </mat-paginator>
                }
            </div>
        </mat-tab>
    </mat-tab-group>
</div>