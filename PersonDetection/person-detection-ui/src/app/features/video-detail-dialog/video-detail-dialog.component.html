<!-- src/app/features/video-detail-dialog/video-detail-dialog.component.html -->

<div class="detail-dialog">
    <h2 mat-dialog-title>
        <mat-icon>assessment</mat-icon>
        Video Analysis Results
    </h2>

    <mat-dialog-content>
        @if (isLoading()) {
        <div class="loading-container">
            <mat-spinner diameter="40"></mat-spinner>
            <p>Loading results...</p>
        </div>
        } @else if (status() || details()) {

        <!-- Header Info -->
        <div class="video-header">
            <div class="video-info">
                <h3>{{ details()?.fileName || status()?.fileName }}</h3>
                <mat-chip [class]="getStateClass(details()?.state || status()?.state)">
                    <mat-icon>{{ getStateIcon(details()?.state || status()?.state) }}</mat-icon>
                    {{ getStateLabel(details()?.state || status()?.state) }}
                </mat-chip>

                @if (details()?.videoFileExists) {
                <button mat-stroked-button color="primary" (click)="playVideo()">
                    <mat-icon>play_arrow</mat-icon>
                    Play Video
                </button>
                }
            </div>

            <!-- Processing Progress - Real-time -->
            @if (status()?.state === VideoProcessingState.Processing) {
            <div class="progress-section">
                <div class="progress-header">
                    <span class="progress-title">
                        <mat-icon class="spin">sync</mat-icon>
                        Processing...
                    </span>
                    <span class="progress-percent">{{ currentProgress() }}%</span>
                </div>
                <mat-progress-bar mode="determinate" [value]="currentProgress()" color="primary">
                </mat-progress-bar>
                <div class="progress-details">
                    <span>{{ currentFrames() }} / {{ totalFrames() || '?' }} frames</span>
                    <span>{{ currentDetections() }} detections</span>
                    <span>{{ currentUniquePersons() }} unique</span>
                </div>
            </div>
            }
        </div>

        <mat-divider></mat-divider>

        <!-- Tabs -->
        <mat-tab-group class="detail-tabs">
            <!-- Overview Tab -->
            <mat-tab label="Overview">
                <div class="tab-content">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon duration">
                                <mat-icon>videocam</mat-icon>
                            </div>
                            <div class="stat-content">
                                <span class="stat-value">{{ formatDuration(details()?.videoDurationSeconds || 0) ||
                                    summary()?.videoDuration || '--' }}</span>
                                <span class="stat-label">Duration</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon frames">
                                <mat-icon>photo_library</mat-icon>
                            </div>
                            <div class="stat-content">
                                <span class="stat-value">{{ details()?.processedFrames ||
                                    summary()?.totalFramesProcessed || currentFrames() || 0 }}</span>
                                <span class="stat-label">Frames Processed</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon detections">
                                <mat-icon>person_search</mat-icon>
                            </div>
                            <div class="stat-content">
                                <span class="stat-value">{{ details()?.totalDetections ||
                                    summary()?.totalPersonsDetected || currentDetections() || 0 }}</span>
                                <span class="stat-label">Total Detections</span>
                            </div>
                        </div>

                        <div class="stat-card highlight">
                            <div class="stat-icon unique">
                                <mat-icon>fingerprint</mat-icon>
                            </div>
                            <div class="stat-content">
                                <span class="stat-value">{{ details()?.uniquePersonCount ||
                                    summary()?.uniquePersonsIdentified || currentUniquePersons() || 0 }}</span>
                                <span class="stat-label">Unique Persons</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon avg">
                                <mat-icon>trending_up</mat-icon>
                            </div>
                            <div class="stat-content">
                                <span class="stat-value">{{ (details()?.averagePersonsPerFrame ??
                                    summary()?.averagePersonsPerFrame)?.toFixed(1) || '--' }}</span>
                                <span class="stat-label">Avg per Frame</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon peak">
                                <mat-icon>groups</mat-icon>
                            </div>
                            <div class="stat-content">
                                <span class="stat-value">{{ details()?.peakPersonCount ?? summary()?.peakPersonCount ??
                                    '--' }}</span>
                                <span class="stat-label">Peak Count</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon time">
                                <mat-icon>timer</mat-icon>
                            </div>
                            <div class="stat-content">
                                <span class="stat-value">{{ formatProcessingTime(details()?.processingTimeSeconds ||
                                    summary()?.processingTimeSeconds) }}</span>
                                <span class="stat-label">Processing Time</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon started">
                                <mat-icon>schedule</mat-icon>
                            </div>
                            <div class="stat-content">
                                <span class="stat-value">{{ (details()?.startedAt || status()?.startedAt) | date:'short'
                                    }}</span>
                                <span class="stat-label">Started</span>
                            </div>
                        </div>
                    </div>
                </div>
            </mat-tab>

            <!-- Person Timeline Tab -->
            <mat-tab label="Person Timeline">
                <div class="tab-content">
                    @if (getPersonTimelines().length > 0) {
                    <div class="person-timeline-grid">
                        @for (person of getPersonTimelines(); track person.globalPersonId) {
                        <div class="person-card">
                            <div class="person-avatar-wrapper">
                                <img [src]="getPersonThumbnailUrl(person.globalPersonId)" class="avatar-thumbnail"
                                    alt="Person {{ person.shortId }}" (error)="onThumbnailError($event)"
                                    (load)="onThumbnailLoad($event)">
                                <div class="avatar-placeholder"
                                    [style.background]="'linear-gradient(135deg, ' + getPersonColor(person.shortId) + ' 0%, ' + getPersonColorDark(person.shortId) + ' 100%)'">
                                    {{ person.shortId }}
                                </div>
                            </div>
                            <div class="person-info">
                                <span class="person-name">Person {{ person.shortId }}</span>
                                <span class="person-stats">{{ person.totalAppearances }} appearances • {{
                                    (person.averageConfidence * 100).toFixed(0) }}%</span>
                                <div class="timeline-bar-wrapper">
                                    <div class="timeline-bar"
                                        [style.left.%]="getTimelinePosition(person.firstAppearanceSeconds)"
                                        [style.width.%]="getTimelineWidth(person.firstAppearanceSeconds, person.lastAppearanceSeconds)"
                                        [style.background]="'linear-gradient(90deg, ' + getPersonColor(person.shortId) + ', ' + getPersonColorDark(person.shortId) + ')'">
                                    </div>
                                </div>
                                <span class="time-range">{{ formatTime(person.firstAppearanceSeconds) }} → {{
                                    formatTime(person.lastAppearanceSeconds) }}</span>
                            </div>
                        </div>
                        }
                    </div>
                    } @else {
                    <div class="empty-tab">
                        <mat-icon>timeline</mat-icon>
                        <p>Timeline data will be available after processing completes</p>
                    </div>
                    }
                </div>
            </mat-tab>

            <!-- Detections Tab -->
            @if (status()?.detections?.length) {
            <mat-tab label="Frame Detections">
                <div class="tab-content">
                    <div class="detections-list">
                        @for (detection of status()?.detections?.slice(0, 50); track detection.frameNumber) {
                        <div class="detection-item" [class.has-persons]="detection.personCount > 0">
                            <div class="frame-info">
                                <span class="frame-number">Frame {{ detection.frameNumber }}</span>
                                <span class="timestamp">{{ formatTime(detection.timestampSeconds) }}</span>
                            </div>
                            <div class="detection-count" [class.active]="detection.personCount > 0">
                                <mat-icon>person</mat-icon>
                                <span>{{ detection.personCount }}</span>
                            </div>
                        </div>
                        }
                    </div>
                    @if ((status()?.detections?.length || 0) > 50) {
                    <p class="showing-limited">Showing first 50 of {{ status()?.detections?.length }} detections</p>
                    }
                </div>
            </mat-tab>
            }
        </mat-tab-group>

        } @else {
        <div class="error-state">
            <mat-icon>error</mat-icon>
            <p>Failed to load video details</p>
        </div>
        }
    </mat-dialog-content>

    <mat-dialog-actions align="end">
        <button mat-button (click)="close()">Close</button>
        @if (details()?.videoFileExists) {
        <button mat-stroked-button color="primary" (click)="playVideo()">
            <mat-icon>play_arrow</mat-icon>
            Play Video
        </button>
        }
        @if (summary() || details()) {
        <button mat-raised-button color="primary" (click)="exportResults()">
            <mat-icon>download</mat-icon>
            Export Results
        </button>
        }
    </mat-dialog-actions>
</div>