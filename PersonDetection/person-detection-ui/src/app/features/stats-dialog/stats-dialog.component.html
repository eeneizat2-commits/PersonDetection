<!-- src/app/features/stats-dialog/stats-dialog.component.html -->
<h2 mat-dialog-title>
    <mat-icon>analytics</mat-icon>
    Historical Statistics
</h2>

<mat-dialog-content>
    <!-- Period Selection -->
    <div class="period-selector">
        <mat-form-field appearance="outline">
            <mat-label>Time Period</mat-label>
            <mat-select [(value)]="selectedPeriod" (selectionChange)="onPeriodChange()">
                <mat-option value="1">Today</mat-option>
                <mat-option value="3">Last 3 Days</mat-option>
                <mat-option value="4">Last 4 Days</mat-option>
                <mat-option value="7">Last 7 Days</mat-option>
                <mat-option value="14">Last 14 Days</mat-option>
                <mat-option value="30">Last 30 Days</mat-option>
                <mat-option value="custom">Custom Range</mat-option>
            </mat-select>
        </mat-form-field>

        <!-- Custom Date Range -->
        <div class="custom-range" *ngIf="selectedPeriod === 'custom'">
            <mat-form-field appearance="outline">
                <mat-label>Start Date</mat-label>
                <input matInput [matDatepicker]="startPicker" [(ngModel)]="customStartDate">
                <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
                <mat-datepicker #startPicker></mat-datepicker>
            </mat-form-field>

            <mat-form-field appearance="outline">
                <mat-label>End Date</mat-label>
                <input matInput [matDatepicker]="endPicker" [(ngModel)]="customEndDate">
                <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
                <mat-datepicker #endPicker></mat-datepicker>
            </mat-form-field>

            <button mat-raised-button color="primary" (click)="applyCustomRange()"
                [disabled]="!customStartDate || !customEndDate">
                Apply
            </button>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div class="loading" *ngIf="loading">
        <mat-spinner diameter="40"></mat-spinner>
        <span>Loading statistics...</span>
    </div>

    <!-- Error Message -->
    <div class="error" *ngIf="error">
        <mat-icon>error</mat-icon>
        {{ error }}
    </div>

    <!-- Stats Content -->
    <div class="stats-content" *ngIf="stats && !loading">
        <!-- Summary Cards -->
        <div class="summary-cards">
            <div class="stat-card total">
                <div class="stat-icon">
                    <mat-icon>people</mat-icon>
                </div>
                <div class="stat-info">
                    <span class="stat-value">{{ stats.totalUniquePersons | number }}</span>
                    <span class="stat-label">Total Unique Persons</span>
                </div>
            </div>

            <div class="stat-card detections">
                <div class="stat-icon">
                    <mat-icon>visibility</mat-icon>
                </div>
                <div class="stat-info">
                    <span class="stat-value">{{ stats.totalDetections | number }}</span>
                    <span class="stat-label">Total Detections</span>
                </div>
            </div>

            <div class="stat-card days">
                <div class="stat-icon">
                    <mat-icon>calendar_today</mat-icon>
                </div>
                <div class="stat-info">
                    <span class="stat-value">{{ stats.totalDays }}</span>
                    <span class="stat-label">Days</span>
                </div>
            </div>

            <div class="stat-card average">
                <div class="stat-icon">
                    <mat-icon>trending_up</mat-icon>
                </div>
                <div class="stat-info">
                    <span class="stat-value">{{ stats.totalDays > 0 ? (stats.totalUniquePersons / stats.totalDays |
                        number:'1.0-0') : 0 }}</span>
                    <span class="stat-label">Daily Average</span>
                </div>
            </div>
        </div>

        <!-- Date Range Display -->
        <div class="date-range">
            <mat-chip-set>
                <mat-chip>
                    <mat-icon>date_range</mat-icon>
                    {{ formatDate(stats.startDate) }} - {{ formatDate(stats.endDate) }}
                </mat-chip>
            </mat-chip-set>
        </div>

        <!-- Daily Breakdown Table -->
        <h3>Daily Breakdown</h3>
        <table mat-table [dataSource]="stats.dailyStats" class="daily-table">
            <!-- Date Column -->
            <ng-container matColumnDef="date">
                <th mat-header-cell *matHeaderCellDef>Date</th>
                <td mat-cell *matCellDef="let row">{{ formatDate(row.date) }}</td>
            </ng-container>

            <!-- Day Name Column -->
            <ng-container matColumnDef="dayName">
                <th mat-header-cell *matHeaderCellDef>Day</th>
                <td mat-cell *matCellDef="let row">{{ row.dayName }}</td>
            </ng-container>

            <!-- Unique Persons Column -->
            <ng-container matColumnDef="uniquePersons">
                <th mat-header-cell *matHeaderCellDef>Unique Persons</th>
                <td mat-cell *matCellDef="let row">
                    <span class="highlight">{{ row.uniquePersons | number }}</span>
                </td>
            </ng-container>

            <!-- Total Detections Column -->
            <ng-container matColumnDef="totalDetections">
                <th mat-header-cell *matHeaderCellDef>Total Detections</th>
                <td mat-cell *matCellDef="let row">{{ row.totalDetections | number }}</td>
            </ng-container>

            <!-- Peak Hour Column -->
            <ng-container matColumnDef="peakHour">
                <th mat-header-cell *matHeaderCellDef>Peak Hour</th>
                <td mat-cell *matCellDef="let row">
                    {{ formatHour(row.peakHour) }}
                    <small>({{ row.peakHourCount }})</small>
                </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>

        <!-- Camera Breakdown -->
        <div class="camera-breakdown" *ngIf="stats.cameraBreakdown && stats.cameraBreakdown.length > 0">
            <h3>Camera Breakdown</h3>
            <div class="camera-cards">
                <div class="camera-card" *ngFor="let cam of stats.cameraBreakdown">
                    <div class="camera-name">
                        <mat-icon>videocam</mat-icon>
                        {{ cam.cameraName }}
                    </div>
                    <div class="camera-stats">
                        <span>{{ cam.totalDetections | number }} detections</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</mat-dialog-content>

<mat-dialog-actions align="end">
    <button mat-button (click)="close()">Close</button>
    <button mat-raised-button color="primary" (click)="loadStats()" [disabled]="loading">
        <mat-icon>refresh</mat-icon>
        Refresh
    </button>
</mat-dialog-actions>